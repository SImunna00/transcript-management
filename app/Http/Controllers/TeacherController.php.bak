<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class TeacherController extends Controller
{
    /**
     * Display teacher dashboard with statistics
     */
    public function dashboard()
    {
        // Comment out database queries and use dummy data instead
        /*
        $teacher = Auth::guard('teacher')->user();

        $stats = [
            'total_courses' => $teacher->courses()->count(),
            'current_courses' => $teacher->courses()
                ->wherePivot('academic_year', date('Y'))
                ->count(),
            'total_students' => User::whereHas('courses', function ($query) use ($teacher) {
                $query->whereIn('course_id', $teacher->courses()->pluck('courses.id'));
            })->count(),
            'pending_marks' => Result::where('submitted_by', $teacher->id)
                ->where('approved', false)
                ->count(),
        ];

        $recent_results = Result::with(['user', 'course'])
            ->where('submitted_by', $teacher->id)
            ->orderBy('created_at', 'desc')
            ->limit(5)
            ->get();
        */

        // Use dummy data
        $stats = [
            'total_courses' => 5,
            'current_courses' => 3,
            'total_students' => 120,
            'pending_marks' => 15,
        ];

        $recent_results = [];

        return view('teacher.dashboard', compact('stats', 'recent_results'));
    }

    /**
     * Show teacher's assigned courses for specific year and term
     */
    public function courses(Request $request)
    {
        // Comment out database queries and use dummy data instead
        /*
        $teacher = Auth::guard('teacher')->user();

        // Get available academic years and terms from the teacher's courses
        $academicYears = $teacher->courses()
            ->orderBy('academic_year', 'desc')
            ->pluck('academic_year')
            ->unique();

        $terms = $teacher->courses()
            ->orderBy('term', 'asc')
            ->pluck('term')
            ->unique();
        */
        
        // Use dummy data
        $academicYears = collect(['2024', '2025']);
        $terms = collect(['Fall', 'Spring', 'Summer']);

        // Get selected year and term (default to the latest)
        $selectedYear = $request->input('year', $academicYears->first());
        $selectedTerm = $request->input('term', $terms->first());

        // Use dummy course data
        $courses = collect([
            (object)[
                'id' => 1,
                'code' => 'CSE-101',
                'name' => 'Introduction to Computer Science',
                'credit_hours' => 3,
                'students_count' => 35,
            ],
            (object)[
                'id' => 2,
                'code' => 'CSE-203',
                'name' => 'Data Structures',
                'credit_hours' => 4,
                'students_count' => 28,
            ],
            (object)[
                'id' => 3,
                'code' => 'CSE-303',
                'name' => 'Database Management Systems',
                'credit_hours' => 3,
                'students_count' => 32,
            ],
        ]);

        return view('teacher.courses', compact(
            'courses',
            'academicYears',
            'terms',
            'selectedYear',
            'selectedTerm'
        ));
    }

    /**
     * Show students enrolled in a specific course
     */
    public function courseStudents(Request $request, $courseId)
    {
        // Comment out database queries
        /*
        $teacher = Auth::guard('teacher')->user();

        // Validate that the teacher is assigned to this course
        $course = $teacher->courses()->findOrFail($courseId);

        // Get the academic year and term from the pivot table
        $academicYear = $request->input('year');
        $term = $request->input('term');

        // Get enrolled students with their result status
        $students = $course->students()
            ->wherePivot('academic_year', $academicYear)
            ->wherePivot('term', $term)
            ->withCount([
                'results' => function ($query) use ($courseId, $academicYear, $term) {
                    $query->where('course_id', $courseId)
                        ->where('academic_year', $academicYear)
                        ->where('term', $term);
                }
            ])
            ->get()
            ->map(function ($student) use ($courseId, $academicYear, $term) {
                $result = $student->results()
                    ->where('course_id', $courseId)
                    ->where('academic_year', $academicYear)
                    ->where('term', $term)
        */
                
        // Use dummy data
        $course = (object)[
            'id' => $courseId,
            'code' => 'CSE-' . $courseId . '01',
            'name' => 'Sample Course ' . $courseId,
            'credit_hours' => 3
        ];
        
        $academicYear = $request->input('year', '2025');
        $term = $request->input('term', 'Fall');
        
        $students = collect([
            (object)[
                'id' => 1,
                'name' => 'John Doe',
                'student_id' => '2025001',
                'has_result' => true,
                'result' => (object)[
                    'id' => 101,
                    'midterm_marks' => 35,
                    'final_marks' => 42,
                    'total_marks' => 77,
                    'grade' => 'A-',
                    'approved' => true
                ]
            ],
            (object)[
                'id' => 2,
                'name' => 'Jane Smith',
                'student_id' => '2025002',
                'has_result' => false,
                'result' => null
            ],
            (object)[
                'id' => 3,
                'name' => 'Michael Brown',
                'student_id' => '2025003',
                'has_result' => false,
                'result' => null
            ],
        ]);

        return view('teacher.course-students', compact(
            'course',
            'students',
            'academicYear',
            'term'
        ));
    }

    /**
     * Show form to input marks for a student
     */
    public function createMarkEntry($courseId, $studentId, Request $request)
    {
        // Comment out database queries
        /*
        $teacher = Auth::guard('teacher')->user();

        // Validate teacher is assigned to this course
        $course = $teacher->courses()->findOrFail($courseId);

        // Get the student
        $student = User::findOrFail($studentId);

        // Get academic year and term
        $academicYear = $request->input('year');
        $term = $request->input('term');

        // Check if result already exists
        $result = Result::where('user_id', $studentId)
        */
        
        // Use dummy data
        $course = (object)[
            'id' => $courseId,
            'code' => 'CSE-' . $courseId . '01',
            'name' => 'Sample Course ' . $courseId,
            'credit_hours' => 3,
            'max_marks' => 100
        ];
        
        $student = (object)[
            'id' => $studentId,
            'name' => 'Student ' . $studentId,
            'student_id' => '2025' . str_pad($studentId, 3, '0', STR_PAD_LEFT)
        ];
        
        $academicYear = $request->input('year', '2025');
        $term = $request->input('term', 'Fall');
        
        $result = null; // Simulating no existing result

        return view('teacher.mark-entry', compact(
            'course',
            'student',
            'academicYear',
            'term',
            'result'
        ));
    }

    /**
     * Store marks for a student
     */
    public function storeMarkEntry(Request $request, $courseId, $studentId)
    {
        // Validate the input
        $validated = $request->validate([
            'attendance' => 'required|numeric|min:0|max:10',
            'class_test' => 'required|numeric|min:0|max:15',
            'mid_term' => 'required|numeric|min:0|max:25',
            'final' => 'required|numeric|min:0|max:40',
            'viva' => 'required|numeric|min:0|max:10',
            'academic_year' => 'required|string',
            'term' => 'required|string',
        ]);
        
        // Skip database operations and just redirect with success message
        return redirect()->route('teacher.courseStudents', [
            'course' => $courseId,
            'year' => $validated['academic_year'],
            'term' => $validated['term'],
        ])->with('success', 'Marks entered successfully!');
    }

    /**
     * View all results submitted by the teacher
     */
    public function viewAllResults(Request $request)
    {
        // Just return an empty view with dummy data
        $results = collect([]);
        $academicYears = collect(['2024', '2025']);
        $terms = collect(['Fall', 'Spring', 'Summer']);
        $courses = collect([]);
        
        return view('teacher.all-results', compact(
            'results',
            'academicYears',
            'terms',
            'courses'
        ));
    }
    
    /**
     * Preview generated PDF
     */
    public function previewResultPDF($resultId)
    {
        // Just return a response with a dummy message
        return response('PDF preview not available in demo mode.', 200);
    }
    
    /**
     * Generate result PDF for a student (dummy version)
     */
    private function generateResultPDF($result)
    {
        // This is a dummy method
        return null;
        $teacher = $result->teacher;

        // Get all results for the student in the same term/year
        $allResults = Result::with('course')
            ->where('user_id', $student->id)
            ->where('academic_year', $result->academic_year)
            ->where('term', $result->term)
            ->get();

        // Calculate TGPA (Term Grade Point Average)
        $totalCredits = $allResults->sum(function ($result) {
            return $result->course->credits;
        });

        $weightedGP = $allResults->sum(function ($result) {
            return $result->grade_point * $result->course->credits;
        });

        $tgpa = $totalCredits > 0 ? $weightedGP / $totalCredits : 0;

        // Generate PDF
        $data = [
            'student' => $student,
            'course' => $course,
            'result' => $result,
            'teacher' => $teacher,
            'allResults' => $allResults,
            'tgpa' => $tgpa,
            'totalCredits' => $totalCredits,
            'print_date' => now()->format('F d, Y'),
        ];

        return PDF::loadView('pdf.result', $data);
    }

    /**
     * View all results submitted by the teacher
     */
    public function viewAllResults(Request $request)
    {
        $teacher = Auth::guard('teacher')->user();

        $query = Result::with(['user', 'course'])
            ->where('submitted_by', $teacher->id);

        // Apply filters if provided
        if ($request->filled('year')) {
            $query->where('academic_year', $request->year);
        }

        if ($request->filled('term')) {
            $query->where('term', $request->term);
        }

        if ($request->filled('course')) {
            $query->where('course_id', $request->course);
        }

        if ($request->filled('status')) {
            $query->where('approved', $request->status === 'approved');
        }

        $results = $query->orderBy('created_at', 'desc')->paginate(20);

        // Get filter options
        $academicYears = Result::where('submitted_by', $teacher->id)
            ->select('academic_year')
            ->distinct()
            ->pluck('academic_year');

        $terms = Result::where('submitted_by', $teacher->id)
            ->select('term')
            ->distinct()
            ->pluck('term');

        $courses = Course::whereHas('results', function ($query) use ($teacher) {
            $query->where('submitted_by', $teacher->id);
        })->get();

        return view('teacher.all-results', compact(
            'results',
            'academicYears',
            'terms',
            'courses'
        ));
    }

    /**
     * Preview generated PDF
     */
    public function previewResultPDF($resultId)
    {
        $teacher = Auth::guard('teacher')->user();

        $result = Result::where('id', $resultId)
            ->where('submitted_by', $teacher->id)
            ->firstOrFail();

        if (!$result->result_file || !Storage::exists($result->result_file)) {
            abort(404, 'Result PDF not found');
        }

        return response()->file(Storage::path($result->result_file));
    }
}
